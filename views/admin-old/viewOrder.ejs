<div class="page-content">
  <div class="container-fluid">

    <div class="title">
      <h4>View Order details</h4>
      <div><small>Date : <%=locals?.orders[0]?.order?.dateOFOrder%></small></div>
    </div><br>

    <ul class="list-group">

      <% locals?.orders?.forEach(e=>{ %>
      <li class="list-group-item">

        <div class="float-right d-flex align-items-center">
          <small><i>Product ID : <%= e?.order?.products?.PID %> </i></small>
          <% if(e?.order?.products?.status=='orderd') {%>
          <span class="badge badge-warning ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
          <div class="spinner-grow spinner-grow-sm text-warning"></div>
          <% }else if(e?.order?.products?.status=='packed'){ %>
          <span class="badge badge-info ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
          <div class="spinner-grow spinner-grow-sm text-info"></div>
          <% }else if(e?.order?.products?.status=='arriving today'){ %>
          <span class="badge badge-primary ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
          <div class="spinner-grow spinner-grow-sm text-primary"></div>
          <% }else if(e?.order?.products?.status=='out for delivery'){ %>
          <span class="badge badge-secondary ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
          <div class="spinner-grow spinner-grow-sm text-secondary"></div>
          <% }else if(e?.order?.products?.status=='delivered'){ %>
          <span class="badge badge-success ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
          <div class="spinner-grow spinner-grow-sm text-success"></div>
          <% }else if(e?.order?.products?.status=='cancelled'){ %>
          <span class="badge badge-danger ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
          <div class="spinner-grow spinner-grow-sm text-danger"></div>
          <% } %>
        </div>

        <div class="media p-3">
          <div class="h-100" style="height: 100%;">
            <img src="/product_images/<%=e?.order?.products?.PID%>1.jpg" alt="" class="mr-3 mt-3 mr-4 rounded" style="width:60px;">
          </div>

          <div class="media-body">
            <h5><%=e?.order?.products?.title?.slice(0,50)+"..."%></h5>

            <div class="card p-3">
              <span>Name : <%= e?.user?.name %> </span>
              <span>Phone : <%= e?.user?.phone %> </span>
              <span>Email : <%= e?.user?.email %> </span>
            </div>

            <div class="card p-3 mt-3">
              <span>House number / House name : <%=e?.order?.address?.houseNumber%></span>
              <span>Town : <%=e?.order?.address?.town%></span>
              <span>Pin code : <%=e?.order?.address?.postalCode%></span>
              <span>State : <%=e?.order?.address?.state%></span>
              <span>Country : <%=e?.order?.address?.country%></span>
              <span>Phone : <%=e?.order?.address?.phone%></span>
            </div>

            <div class="card p-3 mt-3">
              <span style="text-transform: capitalize;">Payment Status : <b><%= e?.order?.products?.paymentStatus %></b></span>
              <% if(e?.order?.products?.offer){ %>
              <span>Price : <s style="color: #ff8b8b;"><%=e?.order?.products?.price%></s>&nbsp;<%=e?.order?.products?.price - e?.order?.products?.offer%> Rs </span>
              <% }else{ %>
              <span>Price : <%=e?.order?.products?.price%> Rs</span>
              <% }; %>
              <span>Quantity : <%=e?.order?.products?.quantity%> Pcs</span>
              <b>Total Amount : <%=e?.order?.products?.total%> Rs</b>
            </div>

            <div class="card p-3 mt-3 ">
              <span style="text-transform: capitalize;" class="d-flex align-items-center">
                Order Status :
                <!-- <%= e?.order?.products?.status %> -->
                <% if(e?.order?.products?.status=='orderd') {%>
                <span class="badge badge-warning ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
                <!-- <div class="spinner-grow spinner-grow-sm text-warning"></div> -->
                <% }else if(e?.order?.products?.status=='packed'){ %>
                <span class="badge badge-info ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
                <!-- <div class="spinner-grow spinner-grow-sm text-info"></div> -->
                <% }else if(e?.order?.products?.status=='arriving today'){ %>
                <span class="badge badge-primary ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
                <!-- <div class="spinner-grow spinner-grow-sm text-primary"></div> -->
                <% }else if(e?.order?.products?.status=='out for delivery'){ %>
                <span class="badge badge-secondary ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
                <!-- <div class="spinner-grow spinner-grow-sm text-secondary"></div> -->
                <% }else if(e?.order?.products?.status=='delivered'){ %>
                <span class="badge badge-success ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
                <!-- <div class="spinner-grow spinner-grow-sm text-success"></div> -->
                <% }else if(e?.order?.products?.status=='cancelled'){ %>
                <span class="badge badge-danger ml-2 mr-2 badge-pill" data-toggle="tooltip" title="<%=locals?.util?.dataToReadable(e?.order?.products?.update)%>"><%=e?.order?.products?.status%></span>
                <!-- <div class="spinner-grow spinner-grow-sm text-danger"></div> -->
                <% } %>
              </span>
              <div>OrderID : <%=locals?.orders[0]?.order?.orderID%></div>
              <div>Date : <%=locals?.orders[0]?.order?.dateOFOrder%></div>
            </div>

            <div class="row mt-3">
              <p class="col-12 mb-1">Update current status</p>
              <div class="input-group input-group-sm col-12">
                <div class="input-group-prepend">
                  <span class="input-group-text">Order Status</span>
                </div>
                <select class="form-control" id="sel1">
                  <option value="<%=e?.order?.products?.status%>"><%= e?.order?.products?.status %> </option>
                  <option value="orderd">Orderd</option>
                  <option value="packed">Packed</option>
                  <option value="arriving today">Arriving today</option>
                  <option value="out for delivery">Out for delivery</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancel order</option>
                </select>
              </div>
            </div>

            <div class="mt-3">
              <button class="btn btn-sm btn-primary d-flex align-items-center" onclick="updateStatus('<%=e?.order?.products?.PID%>','<%=locals?.orders[0]?.order?.orderID%>', this)">
                <span class="spinner-border spinner-border-sm mr-2" style="display: none;"></span>
                <span class="text">Update status</span>
              </button>
            </div>

            <script>
              function updateStatus(PID, orderID, btn) {
                const loading = btn.parentElement.querySelector('span');
                const btnText = btn.parentElement.querySelector('span.text');
                const select = btn.parentElement.parentElement.querySelector("select");
                loading.style.display = 'flex';
                btnText.innerText = 'Update status';
                btnText.innerText = 'Updating...';

                fetch('/admin_panel/orders/update_status', {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      PID: PID,
                      orderID: orderID,
                      status: select?.value
                    })
                  })
                  .then(res => res.json())
                  .then(res => {
                    if (res.status == 'error') {
                      console.warn('Error => ', res.message);
                      btnText.innerText = 'Error updating click to retry';
                      loading.style.display = 'none';
                    } else {
                      btnText.innerText = 'Updated successfully click to re-update';
                      loading.style.display = 'none';
                    };
                  })
                  .catch(e => {
                    console.warn('Error => ', e);
                    btnText.innerText = 'Error connecting to server click to retry';
                    loading.style.display = 'none';
                  });
              };
            </script>

          </div>


        </div>

      </li>
      <% }); %>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <b>Total : <%= locals?.orders[0]?.order?.products?.subTotal %>.00 Rs</b>
        <div class="d-flex align-items-center">
          <div class="spinner-grow text-success"></div>
        </div>
      </li>

    </ul>


  </div>
</div>
